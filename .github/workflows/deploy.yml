name: Deploy to VM

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/crm-demo-key
          chmod 600 ~/.ssh/crm-demo-key
          echo "Host 104.154.114.203
            IdentityFile ~/.ssh/crm-demo-key
            User akash_contextqa_com
            StrictHostKeyChecking no" > ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Cleanup VM Docker resources
        run: |
          echo "ğŸ§¹ Cleaning up Docker resources on VM..."
          ssh 104.154.114.203 "
            docker system prune -af &&
            docker volume prune -f
          "

      - name: Deploy to VM
        run: |
          echo "ğŸ“¥ Copying latest code to VM..."
          ssh 104.154.114.203 "if [ -d ~/idurar-erp-crm ]; then rm -rf ~/idurar-erp-crm; fi"
          scp -r ./ 104.154.114.203:~/idurar-erp-crm

          echo "ğŸ” Setting up SSL certificates and deploying..."
          ssh 104.154.114.203 "
            cd ~/idurar-erp-crm &&
            
            # Create SSL directory in project
            mkdir -p ~/idurar-erp-crm/ssl &&
            
            # Generate self-signed certificate for development
            openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
              -keyout ~/idurar-erp-crm/ssl/key.pem \
              -out ~/idurar-erp-crm/ssl/cert.pem \
              -subj '/C=US/ST=State/L=City/O=Idurar/CN=104.154.114.203' &&
            
            # Set proper permissions
            chmod 600 ~/idurar-erp-crm/ssl/key.pem &&
            chmod 644 ~/idurar-erp-crm/ssl/cert.pem &&
            
            # Stop existing containers
            docker-compose down &&
            
            # Build and start with HTTPS support
            docker-compose build --no-cache &&
            docker-compose up -d &&
            
            # Wait for containers to start
            sleep 10 &&
            
            # Check container status
            docker-compose ps &&
            
            echo 'âœ… Deployment completed with HTTPS support!'
            echo 'ğŸŒ Application available at:'
            echo '   HTTP:  http://104.154.114.203'
            echo '   HTTPS: https://104.154.114.203'
          "
